% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/quantile_mapping.R
\name{perturb_prcp_qm}
\alias{perturb_prcp_qm}
\title{Quantile Mapping for Climate Change Perturbation of Precipitation}
\usage{
perturb_prcp_qm(
  prcp = NULL,
  mean_factor = NULL,
  var_factor = NULL,
  month = NULL,
  year = NULL,
  fit_method = "mme",
  min_events = 10,
  validate_output = TRUE,
  diagnostics = FALSE,
  seed = NULL,
  verbose = FALSE
)
}
\arguments{
\item{prcp}{Numeric vector. Original daily precipitation values to perturb
(typically for one grid cell). Must be non-negative.}

\item{mean_factor}{Numeric matrix of mean change factors (multiplicative),
dimension: `n_years` x 12 (year, month). Each entry scales that year-month's mean.}

\item{var_factor}{Numeric matrix of variance change factors (multiplicative),
dimension: `n_years` x 12 (year, month). Each entry scales that year-month's variance.}

\item{month}{Integer vector (same length as `prcp`). Calendar month for each
day (1-12).}

\item{year}{Integer vector (same length as `prcp`). Simulation year index
for each day (1 = first year, etc).}

\item{fit_method}{Character. Method for fitting the base gamma distribution;
passed to [fitdistrplus::fitdist()]. Default is `"mme"` (method of moments).}

\item{min_events}{Integer. Minimum number of non-zero precipitation events
required per month for distribution fitting. Default is 10.}

\item{validate_output}{Logical. If TRUE, checks output for NaN/Inf and replaces}

\item{diagnostics}{Logical. If TRUE, return diagnostics information in the output.}

\item{seed}{Integer. Optional random seed used when diagnostics require stochastic elements.
with original values. Default is TRUE.}

\item{verbose}{Logical. If TRUE, prints diagnostic messages about months that
cannot be perturbed. Default is FALSE.}
}
\value{
Numeric vector, same length as `prcp`. Precipitation time series perturbed
according to quantile mapping procedure. Includes attributes:
\itemize{
  \item `perturbed_months`: Integer vector of months that were successfully perturbed
  \item `skipped_months`: Integer vector of months skipped due to insufficient data
  \item `n_failed_fits`: Number of distribution fits that failed
}
}
\description{
Applies quantile mapping to adjust a daily precipitation time series to reflect
changes in monthly mean and variance, consistent with climate change scenarios.
The method fits a gamma distribution to observed nonzero precipitation in each
calendar month, then modifies the distribution's mean and variance according to
supplied monthly/yearly change factors, and maps the original values to their
new quantiles in the perturbed distribution.

This function is designed for climate stress-testing workflows to impose
user-specified changes in mean and variance on daily precipitation data while
preserving realistic distributional characteristics.
}
\details{
## Distribution Fitting
The function fits a gamma distribution to non-zero precipitation in each calendar
month. Months with fewer than `min_events` non-zero days are skipped. The gamma
distribution is parameterized with shape and scale parameters derived from the
method of moments or maximum likelihood estimation.

## Quantile Mapping Procedure
1. Fit base gamma distribution to observed non-zero precipitation by month
2. Compute target distribution parameters by scaling base mean and variance
3. Map each original prcp to its quantile in the base distribution
4. Transform to the same quantile in the target distribution

## Limitations
- Zero precipitation values remain zero (dry day frequency unchanged)
- Requires sufficient non-zero events per month for reliable fitting
- Extrapolation beyond observed range may produce unrealistic extreme values
- Change factors must be positive; negative or zero values will cause errors
}
\examples{
\dontrun{
# Example: 2 years of daily data, 5\% mean and 10\% variance increase
set.seed(123)
n_days <- 730
year <- rep(1:2, each = 365)
month_idx <- rep(rep(1:12, times = c(31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31)), 2)[1:n_days]
daily_precip <- rgamma(n_days, shape = 1, scale = 5)

mean_factor <- matrix(1.05, nrow = 2, ncol = 12)
var_factor <- matrix(1.10, nrow = 2, ncol = 12)

perturbed_precip <- perturb_prcp_qm(
  prcp = daily_precip,
  mean_factor = mean_factor,
  var_factor = var_factor,
  month = month_idx,
  year = year
)

# Check which months were perturbed
attr(perturbed_precip, "perturbed_months")
attr(perturbed_precip, "skipped_months")
}

}
\seealso{
\code{\link[fitdistrplus]{fitdist}}
}
