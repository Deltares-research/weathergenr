% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/generator.R
\name{generate_weather}
\alias{generate_weather}
\title{Generate Synthetic Gridded Daily Weather Series}
\usage{
generate_weather(
  obs_data = NULL,
  obs_grid = NULL,
  obs_dates = NULL,
  vars = NULL,
  n_years = NULL,
  start_year = 2020,
  year_start_month = 1,
  n_realizations = 5,
  warm_var = "precip",
  warm_signif = 0.9,
  warm_pool_size = 5000,
  annual_knn_n = 120,
  wet_q = 0.3,
  extreme_q = 0.8,
  dry_spell_factor = rep(1, 12),
  wet_spell_factor = rep(1, 12),
  out_dir = tempdir(),
  seed = NULL,
  parallel = FALSE,
  n_cores = NULL,
  verbose = FALSE
)
}
\arguments{
\item{obs_data}{Named list of data.frames (one per grid cell) with observed
daily weather. Each data.frame must have one row per day corresponding to
\code{obs_dates}, and columns for all \code{vars}.}

\item{obs_grid}{Data.frame describing grid cells. Must contain columns
\code{xind}, \code{yind}, \code{x}, \code{y}. If \code{id} is missing, it is
created as a sequential index.}

\item{obs_dates}{Vector of class \code{Date} corresponding to rows of each
\code{obs_data[[i]]}. May include Feb 29; Feb 29 is removed internally along
with the corresponding rows in \code{obs_data}.}

\item{vars}{Character vector of daily variables to simulate
(e.g., \code{c("precip","temp")}).}

\item{n_years}{Integer number of years to simulate. If \code{NULL}, defaults
to the number of complete historical simulation-years available after
enforcing the 365-day calendar and restricting to the longest contiguous
block of complete years.}

\item{start_year}{Integer first simulation year (calendar year if
\code{year_start_month == 1}, otherwise first water year label).}

\item{year_start_month}{Integer in \code{1:12}. First month of the simulation year.
Use \code{1} for calendar years; use \code{10} for Oct--Sep water years, etc.}

\item{n_realizations}{Integer number of realizations to generate.}

\item{warm_var}{Character name of the annual driver variable used in WARM.
Must be present in \code{vars}.}

\item{warm_signif}{Numeric in (0,1). Wavelet significance level used to retain
low-frequency components in WARM.}

\item{warm_pool_size}{Integer number of candidate annual traces to generate
before filtering down to \code{n_realizations}.}

\item{annual_knn_n}{Integer number of historical analogue years considered in
the annual KNN step of the disaggregation.}

\item{wet_q}{Numeric in (0,1). Wet-day threshold quantile used in the daily
Markov chain classification.}

\item{extreme_q}{Numeric in (0,1). Extreme-day threshold quantile used in the
daily Markov chain classification. Must be greater than \code{wet_q}.}

\item{dry_spell_factor}{Numeric length-12 vector of monthly dry-spell adjustment
factors applied in the Markov-chain persistence logic.}

\item{wet_spell_factor}{Numeric length-12 vector of monthly wet-spell adjustment
factors applied in the Markov-chain persistence logic.}

\item{out_dir}{Character directory for diagnostics and CSV outputs. The
directory is created if it does not exist.}

\item{seed}{Optional integer seed for reproducibility. Used to initialize
RNG streams for annual (WARM) and daily resampling components.}

\item{parallel}{Logical; if \code{TRUE}, run the daily disaggregation across
realizations in parallel using a PSOCK cluster.}

\item{n_cores}{Optional integer number of cores for parallel execution. If
\code{NULL} and \code{parallel = TRUE}, defaults to
\code{max(1, parallel::detectCores() - 1)}.}

\item{verbose}{Logical; if \code{TRUE}, emits progress logs via \code{.log_info()}.}
}
\value{
A list with:
\describe{
  \item{resampled}{Tibble/data.frame with one column per realization. Each
    column contains historical observation dates (\code{dateo}) selected as
    analogues for each simulated day. Column names are \code{rlz_1}, \code{rlz_2}, ...}
  \item{dates}{Vector of class \code{Date} giving the simulated daily time axis
    (Feb 29 excluded).}
}
}
\description{
Generates stochastic gridded daily weather by coupling an annual-scale
low-frequency generator with daily-scale resampling and persistence logic.
The workflow combines:
\itemize{
  \item Wavelet Autoregressive Modeling (WARM) on an annual aggregate of
    \code{warm_var} to simulate low-frequency variability,
  \item annual K-nearest-neighbor (KNN) matching to select historical analogue years,
  \item a three-state (dry, wet, extreme) daily Markov chain to control spell persistence,
  \item daily KNN resampling of precipitation and temperature anomalies.
}

The simulation-year definition is inferred from \code{year_start_month}:
\itemize{
  \item \code{year_start_month == 1}: calendar-year simulation,
  \item \code{year_start_month != 1}: water-year simulation starting in \code{year_start_month}.
}
}
\details{
\strong{Calendar handling (robust Gregorian input):}
Inputs may be on the Gregorian calendar and may include Feb 29. Internally,
the function enforces a 365-day calendar by removing Feb 29 from \code{obs_dates}
and dropping the corresponding rows from every element of \code{obs_data}.
All downstream processing and outputs therefore use a 365-day calendar.

\strong{Workflow:}
\enumerate{
  \item \strong{Historical preprocessing:} Enforce a 365-day calendar, compute
    calendar/water-year indices, and build a historical dates table used for
    KNN matching and Markov chain sequencing.
  \item \strong{Annual WARM simulation:} Aggregate historical daily data to annual
    means (by water year if applicable), run wavelet analysis on the annual
    series, simulate candidate annual traces via \code{\link{simulate_warm}},
    and subset traces using \code{\link{filter_warm_pool}}.
  \item \strong{Daily disaggregation:} For each realization, call
    \code{\link{resample_weather_dates}} to generate a simulated sequence of
    historical analogue dates (in the internal 365-day calendar).
  \item \strong{Output construction:} Map resampled internal dates back to
    historical observation dates (\code{dateo}) and return simulated dates.
}
}
\examples{
\dontrun{
# obs_data: list of grid-cell data.frames with columns precip/temp
# obs_grid: data.frame with xind/yind/x/y
# obs_dates: Date vector aligned with rows of each obs_data[[i]]
out <- generate_weather(
  obs_data = obs_data,
  obs_grid = obs_grid,
  obs_dates = obs_dates,
  vars = c("precip", "temp"),
  start_year = 2020,
  n_years = 30,
  year_start_month = 10,
  n_realizations = 20,
  warm_var = "precip",
  warm_signif = 0.90,
  warm_pool_size = 5000,
  annual_knn_n = 120,
  wet_q = 0.30,
  extreme_q = 0.80,
  out_dir = tempdir(),
  seed = 123,
  parallel = TRUE,
  n_cores = 4,
  verbose = TRUE
)
}

}
