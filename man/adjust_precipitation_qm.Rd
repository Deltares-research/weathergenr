% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/quantile_mapping.R
\name{adjust_precipitation_qm}
\alias{adjust_precipitation_qm}
\title{Adjust Daily Precipitation with Gamma Quantile Mapping Under Monthly Scenario Factors}
\usage{
adjust_precipitation_qm(
  prcp = NULL,
  mean_factor = NULL,
  var_factor = NULL,
  scale_var_with_mean = TRUE,
  exaggerate_extremes = FALSE,
  extreme_prob_threshold = 0.95,
  extreme_k = 1.2,
  enforce_target_mean = TRUE,
  month = NULL,
  year = NULL,
  intensity_threshold = 0,
  fit_method = "mme",
  min_events = 10,
  validate_output = TRUE,
  diagnostics = FALSE,
  seed = NULL,
  verbose = FALSE
)
}
\arguments{
\item{prcp}{Numeric vector. Daily precipitation (mm/day). Must be \code{>= 0}.
\code{NA} values are allowed and pass through unchanged.}

\item{mean_factor}{Numeric matrix with dimensions \code{(n_years x 12)}.
Monthly multiplicative factors applied to the \strong{baseline wet-day mean}
for each month. Entry \code{mean_factor[y, m]} is used for simulation year index
\code{y} and calendar month \code{m}.}

\item{var_factor}{Numeric matrix with dimensions \code{(n_years x 12)}.
Monthly multiplicative factors applied to the \strong{baseline wet-day variance}
for each month. Entry \code{var_factor[y, m]} is used for simulation year index
\code{y} and calendar month \code{m}.}

\item{scale_var_with_mean}{Logical scalar. If \code{TRUE}, the effective variance factor
used to build target distributions is:
\deqn{var\_factor\_use = var\_factor \times mean\_factor^2}
This tends to keep the coefficient of variation (CV) more stable when mean changes
are applied. Default is \code{FALSE}.}

\item{exaggerate_extremes}{Logical scalar. If \code{TRUE}, applies a tail-exponent
transform in probability space above \code{extreme_prob_threshold} before mapping
into the target distribution. This amplifies relative changes in the upper tail while
keeping the Gamma-to-Gamma mapping structure. Default is \code{FALSE}.}

\item{extreme_prob_threshold}{Numeric scalar in \code{(0, 1)}. Defines the start of the
"extreme" tail in baseline probability space. For example, \code{0.95} corresponds to
the top 5\% of wet-day intensities under the baseline month-specific Gamma.
Used only when \code{exaggerate_extremes = TRUE}. Default is \code{0.95}.}

\item{extreme_k}{Numeric scalar \code{> 0}. Tail exponent controlling tail amplification
when \code{exaggerate_extremes = TRUE}. Values \code{> 1} amplify extremes; values in
\code{(0, 1)} dampen them. Default is \code{1.2}.}

\item{enforce_target_mean}{Logical scalar. If \code{TRUE}, rescales mapped wet-day values
within each \code{(year index, month)} group so that the wet-day mean matches the
intended target mean \code{baseline_mean(month) * mean_factor[y, m]}.
This is most relevant when \code{exaggerate_extremes = TRUE} because tail amplification
can shift the mean away from the intended target. Default is \code{TRUE}.}

\item{month}{Integer vector, same length as \code{prcp}. Calendar month for each day
(\code{1}--\code{12}).}

\item{year}{Integer vector, same length as \code{prcp}. \strong{Simulation year index}
for each day (\code{1 =} first simulated year, \code{2 =} second, ...).
Must be a contiguous index set \code{1:n_years}. Do not pass calendar years.
\code{max(year)} must equal \code{nrow(mean_factor)} and \code{nrow(var_factor)}.}

\item{intensity_threshold}{Numeric scalar \code{>= 0}. Defines which values are treated as
wet-day intensities for fitting and mapping: \code{prcp > intensity_threshold}.
Values \code{<= intensity_threshold} are returned unchanged. Default is \code{0}.}

\item{fit_method}{Character scalar. Estimation method passed to
\code{fitdistrplus::fitdist()} for Gamma fitting (e.g., \code{"mme"}, \code{"mle"}).
Default is \code{"mme"}.}

\item{min_events}{Integer scalar. Minimum number of wet-day intensities required within a
month to fit the baseline Gamma. Months with fewer wet-day values are skipped; wet-day
values in skipped months pass through unchanged. Default is \code{10}.}

\item{validate_output}{Logical scalar. If \code{TRUE}, replaces any \code{Inf}/\code{NaN}
produced by the mapping with the original values at those positions and clamps any
negative outputs to zero. Default is \code{TRUE}.}

\item{diagnostics}{Logical scalar. If \code{TRUE}, returns a list containing:
the adjusted series, diagnostics from \code{validate_quantile_mapping()}, and the fitted
objects needed by higher-level workflows (baseline and target Gamma parameters).
Default is \code{FALSE}.}

\item{seed}{Optional integer. If provided, sets a temporary RNG seed via \code{set.seed()}.
The previous RNG state is restored on exit. Default is \code{NULL}.}

\item{verbose}{Logical scalar. If \code{TRUE}, prints progress and warnings for skipped
months and failed fits. Default is \code{FALSE}.}
}
\value{
If \code{diagnostics = FALSE}, returns a numeric vector of the same length as \code{prcp}.
The returned vector has attributes:
\itemize{
  \item \code{perturbed_months}: months (1--12) successfully fitted and perturbed
  \item \code{skipped_months}: months (1--12) skipped due to insufficient data or failed fits
  \item \code{n_failed_fits}: number of monthly Gamma fits that failed
}

If \code{diagnostics = TRUE}, returns a list:
\itemize{
  \item \code{adjusted}: numeric vector as above (with the same attributes)
  \item \code{diagnostics}: output of \code{validate_quantile_mapping()}
  \item \code{base_gamma}: fitted baseline monthly Gamma parameters used for mapping
  \item \code{target_gamma}: target Gamma parameters (month-row x year-index matrices)
  \item \code{var_factor_use}: effective variance factor matrix used to build targets
}
}
\description{
Applies a month-wise **Gamma quantile mapping (QM)** to daily precipitation to impose
prescribed changes in **wet-day intensity** (monthly wet-day mean and variance).

The workflow is:
\enumerate{
  \item Identify "wet-day intensities" as \code{prcp > intensity_threshold}.
  \item For each calendar month, fit a **baseline Gamma distribution** to wet-day
    intensities using \code{fitdistrplus::fitdist()}.
  \item For each \strong{simulation year index} \code{y} and month \code{m}, construct a
    **target Gamma distribution** by scaling baseline moments using
    \code{mean_factor[y, m]} and \code{var_factor[y, m]} (and optionally
    \code{scale_var_with_mean}).
  \item Map each wet-day intensity through the baseline CDF (\code{pgamma}) and then through
    the target inverse CDF (\code{qgamma}).
}

Values \code{<= intensity_threshold} are treated as "dry" for this function and are
returned unchanged. Therefore, this function does \strong{not} change wet-day frequency.
If you need changes in wet/dry spell structure, apply a separate occurrence perturbation.
}
\details{
\strong{Interpretation of mean/variance factors}
\itemize{
  \item Factors apply to wet-day intensities only (\code{prcp > intensity_threshold}).
  \item They do not control wet-day frequency; apply a separate occurrence model if required.
}
}
\seealso{
\code{\link[fitdistrplus]{fitdist}}, \code{\link[stats]{pgamma}}, \code{\link[stats]{qgamma}},
\code{\link{validate_quantile_mapping}}, \code{\link{diagnose_prcp_qm}}
}
