% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/filter_warm_simulations.R
\name{filter_warm_simulations}
\alias{filter_warm_simulations}
\title{Filter and sample WARM simulations by distributional, tail-mass, and wavelet criteria}
\usage{
filter_warm_simulations(
  series.obs = NULL,
  series.sim = NULL,
  sample.num = 5,
  seed = NULL,
  padding = TRUE,
  bounds = list(),
  wavelet.pars = list(signif.level = 0.8, noise.type = "red", period.lower.limit = 2,
    detrend = TRUE),
  make.plots = FALSE,
  verbose = FALSE
)
}
\arguments{
\item{series.obs}{Numeric vector. Observed annual series.}

\item{series.sim}{Numeric matrix. Simulated annual series, with years in rows and
realizations in columns.}

\item{sample.num}{Integer scalar. Number of realizations to sample from the final
candidate pool.}

\item{seed}{Optional integer. Random seed for reproducible window sampling and
candidate sampling.}

\item{padding}{Logical scalar. If TRUE, pads the observed significant-period
set by one index on each side when evaluating presence of observed-relevant signal.}

\item{bounds}{Named list. Overrides defaults for filtering and relaxation parameters.
Common entries include:
\itemize{
  \item mean, sd: relative-difference tolerances.
  \item tail.low.p, tail.high.p: quantile probabilities for tail thresholds.
  \item tail.tol.log: tolerance on |log(M_sim+eps)-log(M_obs+eps)|.
  \item tail.eps: epsilon used inside the log transform.
  \item sig.frac, wavelet.region.tol, wavelet.contrast.tol,
        wavelet.require_presence, wavelet.presence.frac: wavelet filter controls.
  \item relax.*: relaxation settings, including relax.max.iter.
}}

\item{wavelet.pars}{Named list passed to wavelet_spectral_analysis() for
observed and simulated series. Expected entries:
signif.level, noise.type, period.lower.limit, detrend.}

\item{make.plots}{Logical scalar. If TRUE, returns diagnostic ggplot objects.}

\item{verbose}{Logical scalar. If TRUE, prints iteration diagnostics using
logger::log_info().}
}
\value{
A list with elements:
\itemize{
  \item subsetted: matrix of realizations in the final candidate pool
    (original rows from series.sim).
  \item sampled: matrix of sample.num sampled realizations
    (original rows from series.sim).
  \item filter_summary: data.frame with per-filter pass counts and percentages,
    and the final relaxation level.
  \item diagnostics: list containing length/window metadata, pool indices,
    relaxation log, tail-mass details, wavelet diagnostics, and final parameters.
  \item plots: NULL or a list of ggplot objects if make.plots=TRUE.
}
}
\description{
Filters a matrix of simulated annual series (WARM realizations) against an observed
annual series using fast distributional checks (mean, standard deviation),
robust tail-shape checks based on lower/upper tail mass relative to observed
quantile thresholds, and an observed-relevant wavelet (GWS) filter.

The function applies a tiered relaxation strategy when too few candidates pass.
If still insufficient after bounds$relax.max.iter iterations, it falls back
to a deterministic selection of the sample.num realizations with the smallest
absolute relative mean difference.

If make.plots=TRUE, diagnostic plots are returned (time series overlay,
relative-difference scatter facets, and wavelet GWS ribbon/lines).
}
\details{
\strong{Length harmonization:} If observed and simulated series have different
lengths, the function uses n_use = min(length(series.obs), nrow(series.sim)).
A random contiguous window of length n_use is selected from the observed
series (if needed), and each realization receives an independently sampled window
of length n_use (if needed).

\strong{Tail mass metrics:} Let t_L and t_H be observed quantile
thresholds at tail.low.p and tail.high.p. Define lower-tail deficit
mass and upper-tail excess mass (normalized by n_use * robust_scale(obs)),
then compare simulations to observations using log-distance with epsilon
tail.eps.

\strong{Wavelet filter (observed-relevant GWS):} Significant observed periods are
identified where observed GWS / signif > 1. These are grouped into contiguous
regions. For each realization, regional integrated power and regional-to-background
contrast are compared to observed within tolerances, requiring at least
sig.frac of regions to pass. Optionally requires presence of signal.

\strong{Improvements in this version:}
\itemize{
  \item wavelet.presence.frac parameter now exposed (was hardcoded to signif.level)
  \item GWS always cached for efficiency (was conditional on make.plots)
  \item Simplified relaxation logic (removed complex tie-breaking)
  \item Extracted helper functions for better modularity and testability
}
}
\examples{
\dontrun{
out <- filter_warm_simulations(
  series.obs = obs,
  series.sim = sim_mat,
  sample.num = 5,
  seed = 123,
  make.plots = TRUE,
  verbose = TRUE
)
out$filter_summary
out$plots$wavelet_gws
}

}
\seealso{
\code{\link{wavelet_spectral_analysis}}
}
