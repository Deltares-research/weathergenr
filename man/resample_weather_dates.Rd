% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/resample_weather_dates.R
\name{resample_weather_dates}
\alias{resample_weather_dates}
\title{Resample Daily Weather Dates Using Annual KNN and Markov Chain Logic}
\usage{
resample_weather_dates(
  sim_annual_precip,
  obs_annual_precip,
  obs_daily_precip,
  obs_daily_temp,
  sim_year_start,
  k1,
  n_sim_years,
  obs_dates_df,
  sim_dates_df,
  knn.annual.sample.num = 50,
  wet.quantile = 0.2,
  extreme.quantile = 0.8,
  dry.spell.change = rep(1, 12),
  wet.spell.change = rep(1, 12),
  month.start = 1,
  seed = NULL
)
}
\arguments{
\item{sim_annual_precip}{Numeric vector of length \code{n_sim_years}. Synthetic
annual precipitation totals (e.g. WARM output), indexed by simulated year.}

\item{obs_annual_precip}{Numeric vector. Observed annual precipitation totals
corresponding to the historical (water) years used as analog candidates.}

\item{obs_daily_precip}{Numeric vector. Observed daily precipitation values
(no leap days), aligned with \code{obs_dates_df}.}

\item{obs_daily_temp}{Numeric vector. Observed daily temperature values
(no leap days), aligned with \code{obs_dates_df}.}

\item{sim_year_start}{Integer. First simulation year (calendar year if
\code{month.start == 1}, otherwise first water year).}

\item{k1}{Integer. Realization index; used to perturb \code{seed} so that
multiple realizations are independent.}

\item{n_sim_years}{Integer. Number of simulated years.}

\item{obs_dates_df}{Data frame with observed date information. Must include
columns \code{date} (Date), \code{month} (1--12), \code{day} (1--31),
and \code{wyear} (water year identifier).}

\item{sim_dates_df}{Data frame with simulated date information (no leap days).
Must include columns \code{month}, \code{day}, and \code{wyear}.}

\item{knn.annual.sample.num}{Integer. Number of historical years sampled in
the annual KNN step.}

\item{wet.quantile}{Numeric in (0, 1). Quantile used to define monthly wet
thresholds for daily occurrence states.}

\item{extreme.quantile}{Numeric in (0, 1). Quantile used to define monthly
extreme wet thresholds.}

\item{dry.spell.change}{Numeric vector of length 12. Monthly adjustment
factors controlling dry spell persistence in the Markov chain.}

\item{wet.spell.change}{Numeric vector of length 12. Monthly adjustment
factors controlling wet spell persistence in the Markov chain.}

\item{month.start}{Integer in \code{1:12}. First month of the simulation year.
Use 1 for calendar-year simulations; otherwise water-year simulations.}

\item{seed}{Optional integer. Base random seed for reproducibility.}
}
\value{
A \code{Date} vector of length \code{nrow(sim_dates_df)} giving the resampled
observed dates corresponding to each simulated day.
}
\description{
Resamples daily precipitation and temperature sequences by combining:
\itemize{
  \item{Annual K-nearest-neighbor (KNN) selection of observed years}
  \item{A three-state Markov chain for wet/dry/extreme spell persistence}
  \item{Daily KNN resampling on precipitation and temperature anomalies}
}

The function supports both calendar-year and water-year simulations.
The regime is inferred from \code{month.start}: if \code{month.start == 1},
calendar-year logic is used; otherwise water-year logic is assumed.
}
\details{
Workflow per simulated year:
\enumerate{
  \item{Select analog observed years via annual KNN matching on totals.}
  \item{Compute month-specific wet and extreme precipitation thresholds.}
  \item{Fit monthly Markov transition probabilities using observed lagged
        precipitation and thresholds (via \code{monthly_markov_probs}).}
  \item{Simulate daily occurrence states via the Markov chain
        (via \code{markov_next_state}).}
  \item{For each simulated day, search observed candidate days matching the
        current calendar day (plus windows), filter candidates by the required
        state transition, then select the next day via daily KNN on
        precipitation and temperature anomalies.}
}

Performance notes:
\itemize{
  \item{All Dates are handled internally as integer day counts to avoid
        \code{[<-.Date} overhead in tight loops. The final output is converted
        back to \code{Date} once.}
  \item{Month-day lookups use integer keys (\code{month*32 + day}) instead of
        \code{paste()}, avoiding repeated string allocation.}
  \item{State classification and transition codes are precomputed once per
        analog-year block and per month threshold, avoiding repeated
        \code{ifelse()} and subsetting in the daily loop.}
}

Calendar-year safeguard:
in calendar-year mode (\code{month.start == 1}), candidate transitions that
cross water-year boundaries are excluded (prevents Dec--Jan cross-year
contamination).
}
\examples{
\dontrun{
sim_dates <- resample_weather_dates(
  sim_annual_precip, obs_annual_precip,
  obs_daily_precip, obs_daily_temp,
  sim_year_start = 2000, k1 = 1, n_sim_years = 30,
  obs_dates_df = obs_dates_df, sim_dates_df = sim_dates_df,
  month.start = 1, seed = 123
)
}

}
