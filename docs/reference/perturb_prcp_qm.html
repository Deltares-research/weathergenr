<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Quantile Mapping for Climate Change Perturbation of Precipitation — perturb_prcp_qm • weathergenr</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Quantile Mapping for Climate Change Perturbation of Precipitation — perturb_prcp_qm"><meta name="description" content="Applies quantile mapping to adjust a daily precipitation time series to reflect
changes in monthly mean and variance, consistent with climate change scenarios.
The method fits a gamma distribution to observed nonzero precipitation in each
calendar month, then modifies the distribution's mean and variance according to
supplied monthly/yearly change factors, and maps the original values to their
new quantiles in the perturbed distribution.
This function is designed for climate stress-testing workflows to impose
user-specified changes in mean and variance on daily precipitation data while
preserving realistic distributional characteristics."><meta property="og:description" content="Applies quantile mapping to adjust a daily precipitation time series to reflect
changes in monthly mean and variance, consistent with climate change scenarios.
The method fits a gamma distribution to observed nonzero precipitation in each
calendar month, then modifies the distribution's mean and variance according to
supplied monthly/yearly change factors, and maps the original values to their
new quantiles in the perturbed distribution.
This function is designed for climate stress-testing workflows to impose
user-specified changes in mean and variance on daily precipitation data while
preserving realistic distributional characteristics."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">weathergenr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Deltares-research/weathergenr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Quantile Mapping for Climate Change Perturbation of Precipitation</h1>
      <small class="dont-index">Source: <a href="https://github.com/Deltares-research/weathergenr/blob/HEAD/R/perturb_prcp_qm.R" class="external-link"><code>R/perturb_prcp_qm.R</code></a></small>
      <div class="d-none name"><code>perturb_prcp_qm.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Applies quantile mapping to adjust a daily precipitation time series to reflect
changes in monthly mean and variance, consistent with climate change scenarios.
The method fits a gamma distribution to observed nonzero precipitation in each
calendar month, then modifies the distribution's mean and variance according to
supplied monthly/yearly change factors, and maps the original values to their
new quantiles in the perturbed distribution.</p>
<p>This function is designed for climate stress-testing workflows to impose
user-specified changes in mean and variance on daily precipitation data while
preserving realistic distributional characteristics.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">perturb_prcp_qm</span><span class="op">(</span></span>
<span>  prcp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  mean_factor <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  var_factor <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  month <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  year <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fit_method <span class="op">=</span> <span class="st">"mme"</span>,</span>
<span>  min_events <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  validate_output <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  diagnostics <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-prcp">prcp<a class="anchor" aria-label="anchor" href="#arg-prcp"></a></dt>
<dd><p>Numeric vector. Original daily precipitation values to perturb
(typically for one grid cell). Must be non-negative.</p></dd>


<dt id="arg-mean-factor">mean_factor<a class="anchor" aria-label="anchor" href="#arg-mean-factor"></a></dt>
<dd><p>Numeric matrix of mean change factors (multiplicative),
dimension: `n_years` x 12 (year, month). Each entry scales that year-month's mean.</p></dd>


<dt id="arg-var-factor">var_factor<a class="anchor" aria-label="anchor" href="#arg-var-factor"></a></dt>
<dd><p>Numeric matrix of variance change factors (multiplicative),
dimension: `n_years` x 12 (year, month). Each entry scales that year-month's variance.</p></dd>


<dt id="arg-month">month<a class="anchor" aria-label="anchor" href="#arg-month"></a></dt>
<dd><p>Integer vector (same length as `prcp`). Calendar month for each
day (1-12).</p></dd>


<dt id="arg-year">year<a class="anchor" aria-label="anchor" href="#arg-year"></a></dt>
<dd><p>Integer vector (same length as `prcp`). Simulation year index
for each day (1 = first year, etc).</p></dd>


<dt id="arg-fit-method">fit_method<a class="anchor" aria-label="anchor" href="#arg-fit-method"></a></dt>
<dd><p>Character. Method for fitting the base gamma distribution;
passed to [fitdistrplus::fitdist()]. Default is `"mme"` (method of moments).</p></dd>


<dt id="arg-min-events">min_events<a class="anchor" aria-label="anchor" href="#arg-min-events"></a></dt>
<dd><p>Integer. Minimum number of non-zero precipitation events
required per month for distribution fitting. Default is 10.</p></dd>


<dt id="arg-validate-output">validate_output<a class="anchor" aria-label="anchor" href="#arg-validate-output"></a></dt>
<dd><p>Logical. If TRUE, checks output for NaN/Inf and replaces</p></dd>


<dt id="arg-diagnostics">diagnostics<a class="anchor" aria-label="anchor" href="#arg-diagnostics"></a></dt>
<dd><p>Logical. If TRUE, return diagnostics information in the output.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Integer. Optional random seed used when diagnostics require stochastic elements.
with original values. Default is TRUE.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical. If TRUE, prints diagnostic messages about months that
cannot be perturbed. Default is FALSE.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Numeric vector, same length as `prcp`. Precipitation time series perturbed
according to quantile mapping procedure. Includes attributes:</p><ul><li><p>`perturbed_months`: Integer vector of months that were successfully perturbed</p></li>
<li><p>`skipped_months`: Integer vector of months skipped due to insufficient data</p></li>
<li><p>`n_failed_fits`: Number of distribution fits that failed</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>## Distribution Fitting
The function fits a gamma distribution to non-zero precipitation in each calendar
month. Months with fewer than `min_events` non-zero days are skipped. The gamma
distribution is parameterized with shape and scale parameters derived from the
method of moments or maximum likelihood estimation.</p>
<p>## Quantile Mapping Procedure
1. Fit base gamma distribution to observed non-zero precipitation by month
2. Compute target distribution parameters by scaling base mean and variance
3. Map each original prcp to its quantile in the base distribution
4. Transform to the same quantile in the target distribution</p>
<p>## Limitations
- Zero precipitation values remain zero (dry day frequency unchanged)
- Requires sufficient non-zero events per month for reliable fitting
- Extrapolation beyond observed range may produce unrealistic extreme values
- Change factors must be positive; negative or zero values will cause errors</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="https://lbbe-software.github.io/fitdistrplus/reference/fitdist.html" class="external-link">fitdist</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Example: 2 years of daily data, 5% mean and 10% variance increase</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">n_days</span> <span class="op">&lt;-</span> <span class="fl">730</span></span></span>
<span class="r-in"><span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="fl">365</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">month_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">31</span>, <span class="fl">28</span>, <span class="fl">31</span>, <span class="fl">30</span>, <span class="fl">31</span>, <span class="fl">30</span>, <span class="fl">31</span>, <span class="fl">31</span>, <span class="fl">30</span>, <span class="fl">31</span>, <span class="fl">30</span>, <span class="fl">31</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_days</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">daily_precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n_days</span>, shape <span class="op">=</span> <span class="fl">1</span>, scale <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mean_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1.05</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">var_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1.10</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">perturbed_precip</span> <span class="op">&lt;-</span> <span class="fu">perturb_prcp_qm</span><span class="op">(</span></span></span>
<span class="r-in"><span>  prcp <span class="op">=</span> <span class="va">daily_precip</span>,</span></span>
<span class="r-in"><span>  mean_factor <span class="op">=</span> <span class="va">mean_factor</span>,</span></span>
<span class="r-in"><span>  var_factor <span class="op">=</span> <span class="va">var_factor</span>,</span></span>
<span class="r-in"><span>  month <span class="op">=</span> <span class="va">month_idx</span>,</span></span>
<span class="r-in"><span>  year <span class="op">=</span> <span class="va">year</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check which months were perturbed</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">perturbed_precip</span>, <span class="st">"perturbed_months"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">perturbed_precip</span>, <span class="st">"skipped_months"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by M.Umit Taner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

