<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Read NetCDF inputs, generate stochastic realizations, and evaluate generator skill.">

<title>getting_started</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="getting_started_files/libs/clipboard/clipboard.min.js"></script>
<script src="getting_started_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="getting_started_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="getting_started_files/libs/quarto-html/popper.min.js"></script>
<script src="getting_started_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="getting_started_files/libs/quarto-html/anchor.min.js"></script>
<link href="getting_started_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="getting_started_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="getting_started_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="getting_started_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="getting_started_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Getting Started with weathergenr</h1>
</div>

<div>
  <div class="description">
    Read NetCDF inputs, generate stochastic realizations, and evaluate generator skill.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>The <strong>weathergenr</strong> package provides a comprehensive toolkit for stochastic weather generation and climate data analysis. It implements sophisticated statistical methods to create synthetic daily weather series that preserve the statistical properties of observed climate data while enabling scenario-based climate impact assessments.</p>
<p>This vignette demonstrates the core workflow:</p>
<ol type="1">
<li>Reading gridded meteorological data from NetCDF files</li>
<li>Generating synthetic weather realizations using coupled statistical methods<br>
</li>
<li>Evaluating the quality of synthetic weather against historical observations</li>
</ol>
<section id="load-required-packages" class="level2">
<h2 class="anchored" data-anchor-id="load-required-packages">Load Required Packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(weathergenr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Related functions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>[<code>read_netcdf()</code>]</li>
<li>[<code>generate_weather()</code>]</li>
<li>[<code>evaluate_weather_generator()</code>]</li>
<li>[<code>write_netcdf()</code>]</li>
<li>[<code>apply_climate_perturbations()</code>]</li>
<li>[<code>analyze_wavelet_spectrum()</code>]</li>
</ul>
</div>
</div>
</section>
</section>
<section id="reading-gridded-multivariate-weather-data" class="level1">
<h1>Reading Gridded Multivariate Weather Data</h1>
<section id="about-the-example-dataset" class="level2">
<h2 class="anchored" data-anchor-id="about-the-example-dataset">About the Example Dataset</h2>
<p>For this tutorial, we use the ERA5 dataset (ECMWF Reanalysis v5) included with the package. The data covers the Ntoum Basin in Gabon, a tropical watershed in West Central Africa. The dataset includes daily precipitation, mean temperature, minimum temperature, and maximum temperature at a 0.25-degree spatial resolution.</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="figures/ntoum_basin.png" class="img-fluid figure-img" style="width:40.0%"></p>
<figcaption>Map of Ntoum Basin, Gabon</figcaption>
</figure>
</div>
</section>
<section id="loading-netcdf-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-netcdf-data">Loading NetCDF Data</h2>
<p>The <code>read_netcdf()</code> function provides an efficient interface for extracting meteorological data from NetCDF files. It handles the complexities of NetCDF format and returns data in a tidy, analysis-ready structure optimized for the weathergenr workflow.</p>
<section id="key-features" class="level3">
<h3 class="anchored" data-anchor-id="key-features">Key Features</h3>
<p>The function performs several important operations:</p>
<ul>
<li>Extracts spatial coordinates and temporal information</li>
<li>Organizes data into per-grid-cell time series</li>
<li>Handles calendar systems including leap day management</li>
<li>Provides variable renaming capabilities</li>
<li>Optionally drops variables with all missing values to reduce memory usage</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Locate the example NetCDF file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ncfile <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"ntoum_era5_data.nc"</span>, <span class="at">package =</span> <span class="st">"weathergenr"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the NetCDF file with default settings</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ncdata <span class="ot">&lt;-</span> <span class="fu">read_netcdf</span>(ncfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="understanding-the-output-structure" class="level3">
<h3 class="anchored" data-anchor-id="understanding-the-output-structure">Understanding the Output Structure</h3>
<p>The <code>read_netcdf()</code> function returns a list with five components that organize different aspects of the climate data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the top-level structure</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ncdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "data"       "grid"       "date"       "dimensions" "attributes"</code></pre>
</div>
</div>
<section id="time-series-data" class="level4">
<h4 class="anchored" data-anchor-id="time-series-data">1. Time Series Data</h4>
<p>The <code>data</code> element contains a list of data frames, one for each grid cell. Each data frame represents a daily time series with columns for each meteorological variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the first grid cell's time series</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ncdata<span class="sc">$</span>data[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  press_msl      kin temp_min temp_max     temp     kout precip
1  1008.232 173.8779 24.39999 28.13000 25.89001 409.9045   9.12
2  1008.105 161.9229 23.67999 28.08002 24.89001 410.2427  15.59
3  1007.561 201.3387 23.58002 27.89001 25.64001 410.5097   4.84
4  1007.602 176.7380 25.04001 28.31000 26.13000 410.7956   5.20
5  1007.330 217.5677 24.61002 28.12000 26.13000 411.1073   1.54
6  1007.161 198.7215 25.02002 28.17999 26.34000 411.4271   8.35</code></pre>
</div>
</div>
<p>This structure allows efficient access to complete time series for individual locations while maintaining a compact memory footprint.</p>
</section>
<section id="spatial-grid-information" class="level4">
<h4 class="anchored" data-anchor-id="spatial-grid-information">2. Spatial Grid Information</h4>
<p>The <code>grid</code> element provides spatial metadata for each grid cell:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View grid metadata</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ncdata<span class="sc">$</span>grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
     id  xind  yind         x         y
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl[1d]&gt; &lt;dbl[1d]&gt;
1     1     1     1      9.5       0.5 
2     2     2     1      9.75      0.5 
3     3     3     1     10         0.5 
4     4     1     2      9.5       0.25
5     5     2     2      9.75      0.25
6     6     3     2     10         0.25</code></pre>
</div>
</div>
<p>Each row describes a grid cell with:</p>
<ul>
<li><code>id</code>: Sequential identifier for the grid cell</li>
<li><code>xind</code>, <code>yind</code>: Array indices in the original NetCDF file</li>
<li><code>x</code>, <code>y</code>: Spatial coordinates (longitude/latitude or projected coordinates)</li>
</ul>
</section>
<section id="temporal-information" class="level4">
<h4 class="anchored" data-anchor-id="temporal-information">3. Temporal Information</h4>
<p>The <code>date</code> element contains the complete time axis as a vector of Date objects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first and last few dates</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ncdata<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2000-01-01" "2000-01-02" "2000-01-03" "2000-01-04" "2000-01-05"
[6] "2000-01-06"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(ncdata<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-12-26" "2020-12-27" "2020-12-28" "2020-12-29" "2020-12-30"
[6] "2020-12-31"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Confirm the total number of days</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(ncdata<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7671</code></pre>
</div>
</div>
</section>
<section id="dimension-vectors" class="level4">
<h4 class="anchored" data-anchor-id="dimension-vectors">4. Dimension Vectors</h4>
<p>The <code>dimensions</code> element stores the raw dimension vectors from the NetCDF file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View available dimensions</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ncdata<span class="sc">$</span>dimensions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "longitude" "latitude"  "time"     </code></pre>
</div>
</div>
</section>
<section id="metadata-attributes" class="level4">
<h4 class="anchored" data-anchor-id="metadata-attributes">5. Metadata Attributes</h4>
<p>The <code>attributes</code> element preserves variable attributes, spatial reference information, and global metadata from the NetCDF file, ensuring traceability and documentation.</p>
</section>
</section>
<section id="advanced-usage" class="level3">
<h3 class="anchored" data-anchor-id="advanced-usage">Advanced Usage</h3>
<p>The <code>read_netcdf()</code> function supports several optional parameters for customized data loading:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Load specific variables and rename them</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>ncdata <span class="ot">&lt;-</span> <span class="fu">read_netcdf</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">nc_path =</span> ncfile,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">var =</span> <span class="fu">c</span>(<span class="st">"precip"</span>, <span class="st">"temp"</span>),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">var_name =</span> <span class="fu">c</span>(<span class="at">precip =</span> <span class="st">"precipitation"</span>, <span class="at">temp =</span> <span class="st">"temperature"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Handle 365-day calendar data (no leap days)</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>ncdata <span class="ot">&lt;-</span> <span class="fu">read_netcdf</span>(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">nc_path =</span> ncfile,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">keep_leap_day =</span> <span class="cn">FALSE</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Round values to reduce precision and memory</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>ncdata <span class="ot">&lt;-</span> <span class="fu">read_netcdf</span>(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">nc_path =</span> ncfile,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">signif_digits =</span> <span class="dv">4</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">drop_all_na =</span> <span class="cn">TRUE</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="generating-stochastic-weather-realizations" class="level1">
<h1>Generating Stochastic Weather Realizations</h1>
<section id="overview-of-the-weather-generation-method" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-the-weather-generation-method">Overview of the Weather Generation Method</h2>
<p>The <code>generate_weather()</code> function implements a sophisticated multi-scale weather generation framework that combines several statistical methods:</p>
<section id="statistical-components" class="level3">
<h3 class="anchored" data-anchor-id="statistical-components">Statistical Components</h3>
<ol type="1">
<li><p><strong>Wavelet Autoregressive Modeling (WARM)</strong>: Captures low-frequency (annual to multi-year) climate variability by decomposing annual precipitation signals into wavelet components and simulating their temporal evolution using ARIMA models.</p></li>
<li><p><strong>Markov Chain Model</strong>: Controls the persistence of wet and dry spells at the daily scale by modeling transitions between three precipitation states (dry, wet, extreme) with monthly-varying transition probabilities.</p></li>
<li><p><strong>K-Nearest Neighbors (KNN) Resampling</strong>: Selects historical analogue years based on similarity in annual precipitation patterns and resamples daily weather sequences from these analogues while preserving spatial and temporal correlations.</p></li>
</ol>
<p>This coupled approach ensures that synthetic weather series preserve both:</p>
<ul>
<li><strong>Temporal structure</strong>: Day-to-day persistence, seasonal cycles, and interannual variability</li>
<li><strong>Spatial coherence</strong>: Correlations between grid cells and co-occurrence patterns of weather events</li>
<li><strong>Statistical properties</strong>: Means, variances, extremes, and distributional characteristics</li>
</ul>
<p>The method is described in detail by <a href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/wrcr.20528">Steinschneider and Brown (2013)</a>.</p>
</section>
</section>
<section id="setting-up-the-simulation" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-simulation">Setting Up the Simulation</h2>
<p>First, define the output directory and specify which meteorological variables to simulate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a temporary directory for outputs</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>output_path <span class="ot">&lt;-</span> <span class="fu">tempdir</span>()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define variables to simulate</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"precip"</span>, <span class="st">"temp"</span>, <span class="st">"temp_min"</span>, <span class="st">"temp_max"</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Labels for plotting (optional)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>variable_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Precipitation"</span>, <span class="st">"Temperature (mean)"</span>, </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Temperature (min)"</span>, <span class="st">"Temperature (max)"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of stochastic realizations to generate</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>realization_num <span class="ot">&lt;-</span> <span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="understanding-simulation-parameters" class="level3">
<h3 class="anchored" data-anchor-id="understanding-simulation-parameters">Understanding Simulation Parameters</h3>
<p>Key parameters control different aspects of the weather generation:</p>
<ul>
<li><strong>Temporal scope</strong>: <code>n_years</code> and <code>start_year</code> define the simulation period</li>
<li><strong>Realization count</strong>: <code>n_realizations</code> specifies how many independent synthetic series to create</li>
<li><strong>WARM parameters</strong>: Control annual-scale variability simulation
<ul>
<li><code>warm_var</code>: The primary driver variable (typically precipitation)</li>
<li><code>warm_signif</code>: Significance threshold for retaining wavelet components (0.90 = 90% confidence)</li>
<li><code>warm_pool_size</code>: Number of candidate annual traces to generate before filtering</li>
</ul></li>
<li><strong>KNN parameters</strong>: Control daily-scale resampling
<ul>
<li><code>annual_knn_n</code>: Number of historical analogue years to consider</li>
</ul></li>
<li><strong>Markov Chain parameters</strong>: Define precipitation state thresholds
<ul>
<li><code>wet_q</code>: Threshold for wet day classification (0.3 = 30th percentile)</li>
<li><code>extreme_q</code>: Threshold for extreme precipitation (0.8 = 80th percentile)</li>
</ul></li>
</ul>
</section>
</section>
<section id="running-the-weather-generator" class="level2">
<h2 class="anchored" data-anchor-id="running-the-weather-generator">Running the Weather Generator</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set a seed for reproducibility</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> <span class="dv">123</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate synthetic weather series</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>stochastic_weather <span class="ot">&lt;-</span> <span class="fu">generate_weather</span>(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs_data =</span> ncdata<span class="sc">$</span>data,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs_grid =</span> ncdata<span class="sc">$</span>grid,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">obs_dates =</span> ncdata<span class="sc">$</span>date,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">vars =</span> variables,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_years =</span> <span class="dv">20</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_year =</span> <span class="dv">2020</span>,</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">year_start_month =</span> <span class="dv">1</span>,</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_realizations =</span> realization_num,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">warm_var =</span> <span class="st">"precip"</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">warm_signif =</span> <span class="fl">0.90</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">warm_pool_size =</span> <span class="dv">10000</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">annual_knn_n =</span> <span class="dv">100</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">wet_q =</span> <span class="fl">0.2</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">extreme_q =</span> <span class="fl">0.8</span>,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_dir =</span> output_path,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> seed,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_cores =</span> <span class="cn">NULL</span>,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="understanding-the-output" class="level3">
<h3 class="anchored" data-anchor-id="understanding-the-output">Understanding the Output</h3>
<p>The function returns a list containing:</p>
<ul>
<li><code>resampled</code>: The historical dates selected as analogues for each simulation day</li>
<li><code>dates</code>: The simulated daily time axis (always 365-day calendar, Feb 29 excluded)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View the structure of the output</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(stochastic_weather)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "resampled" "dates"    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the simulated date range</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stochastic_weather<span class="sc">$</span>dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-01-01" "2020-01-02" "2020-01-03" "2020-01-04" "2020-01-05"
[6] "2020-01-06"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(stochastic_weather<span class="sc">$</span>dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2039-12-26" "2039-12-27" "2039-12-28" "2039-12-29" "2039-12-30"
[6] "2039-12-31"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine resampled dates for the first realization</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stochastic_weather<span class="sc">$</span>resampled[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2016-01-01" "2015-01-01" "2016-01-20" "2015-01-02" "2015-01-03"
[6] "2015-01-07"</code></pre>
</div>
</div>
</section>
<section id="interpreting-resampled-dates" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-resampled-dates">Interpreting Resampled Dates</h3>
<p>The resampled dates show which historical days were selected as analogues. This information reveals:</p>
<ul>
<li>Whether the generator is drawing from wet or dry historical periods</li>
<li>The diversity of historical conditions being sampled</li>
<li>Temporal clustering patterns in the resampling scheme</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display resampled dates for all realizations</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>stochastic_weather<span class="sc">$</span>resampled</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,300 × 3
   rlz_1      rlz_2      rlz_3     
   &lt;date&gt;     &lt;date&gt;     &lt;date&gt;    
 1 2016-01-01 2017-01-01 2015-01-01
 2 2015-01-01 2017-01-04 2005-01-28
 3 2016-01-20 2002-01-02 2010-01-29
 4 2015-01-02 2002-01-07 2010-01-16
 5 2015-01-03 2002-01-08 2010-01-04
 6 2015-01-07 2002-01-09 2010-01-05
 7 2015-01-09 2002-01-10 2010-01-06
 8 2015-01-10 2002-01-07 2010-01-11
 9 2015-01-10 2014-01-08 2010-01-12
10 2015-01-10 2014-01-08 2010-01-10
# ℹ 7,290 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="extracting-synthetic-weather-data" class="level2">
<h2 class="anchored" data-anchor-id="extracting-synthetic-weather-data">Extracting Synthetic Weather Data</h2>
<p>To access the actual weather values (not just the resampled dates), you need to extract the corresponding data from the historical record:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Extract synthetic weather for all realizations</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>synthetic_data <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>realization_num) {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the day order for this realization</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  day_order <span class="ot">&lt;-</span> <span class="fu">match</span>(stochastic_weather<span class="sc">$</span>resampled[[i]], ncdata<span class="sc">$</span>date)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract corresponding weather data for each grid cell</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  synthetic_data[[i]] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ncdata<span class="sc">$</span>data, <span class="cf">function</span>(cell_data) {</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    cell_data[day_order, variables] <span class="sc">%&gt;%</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">date =</span> stochastic_weather<span class="sc">$</span>dates, <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="evaluating-synthetic-weather-series" class="level1">
<h1>Evaluating Synthetic Weather Series</h1>
<section id="purpose-of-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="purpose-of-evaluation">Purpose of Evaluation</h2>
<p>Validating the weather generator’s performance is crucial to ensure that synthetic weather series are suitable for impact modeling. The <code>evaluate_weather_generator()</code> function provides comprehensive diagnostic comparisons between simulated and observed weather across multiple statistical dimensions.</p>
</section>
<section id="preparing-data-for-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="preparing-data-for-evaluation">Preparing Data for Evaluation</h2>
<p>The evaluation function requires:</p>
<ol type="1">
<li>Observed weather data in list format (one element per grid cell)</li>
<li>Simulated weather data structured similarly</li>
<li>Matching date columns in both datasets</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create day order indices for each realization</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>day_order <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">:</span>realization_num,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(n) <span class="fu">match</span>(stochastic_weather<span class="sc">$</span>resampled[[n]], ncdata<span class="sc">$</span>date)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract synthetic weather samples</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>rlz_sample <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>realization_num) {</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  rlz_sample[[n]] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ncdata<span class="sc">$</span>data[ncdata<span class="sc">$</span>grid<span class="sc">$</span>id], <span class="cf">function</span>(x) {</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    x[day_order[, n], ] <span class="sc">%&gt;%</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(precip, temp, temp_min, temp_max) <span class="sc">%&gt;%</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">date =</span> stochastic_weather<span class="sc">$</span>dates, <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare observed data</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>obs_sample <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ncdata<span class="sc">$</span>data[ncdata<span class="sc">$</span>grid<span class="sc">$</span>id], <span class="cf">function</span>(x) {</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(precip, temp, temp_min, temp_max) <span class="sc">%&gt;%</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> ncdata<span class="sc">$</span>date, <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="running-the-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="running-the-evaluation">Running the Evaluation</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate weather generator performance</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>evaluation_plots <span class="ot">&lt;-</span> <span class="fu">evaluate_weather_generator</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">daily_sim =</span> rlz_sample,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">daily_obs =</span> obs_sample,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">variables =</span> variables,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable_labels =</span> variable_labels,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_realizations =</span> realization_num,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">wet_quantile =</span> <span class="fl">0.3</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">extreme_quantile =</span> <span class="fl">0.8</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_path =</span> <span class="cn">NULL</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="understanding-evaluation-metrics" class="level2">
<h2 class="anchored" data-anchor-id="understanding-evaluation-metrics">Understanding Evaluation Metrics</h2>
<p>The evaluation function computes and visualizes several key aspects of weather generator performance:</p>
<section id="daily-statistics" class="level3">
<h3 class="anchored" data-anchor-id="daily-statistics">1. Daily Statistics</h3>
<p>Comparison of mean, standard deviation, and skewness for each variable across all grid cells. This assesses whether the generator preserves the central tendency, variability, and distributional shape of observed weather.</p>
</section>
<section id="wet-and-dry-day-frequencies" class="level3">
<h3 class="anchored" data-anchor-id="wet-and-dry-day-frequencies">2. Wet and Dry Day Frequencies</h3>
<p>For precipitation, the evaluation examines:</p>
<ul>
<li>Total number of wet days (above the wet threshold)</li>
<li>Number of extreme precipitation days (above the extreme threshold)</li>
<li>Dry day frequencies</li>
</ul>
<p>These metrics reveal whether the generator correctly reproduces precipitation occurrence patterns.</p>
</section>
<section id="spell-length-distributions" class="level3">
<h3 class="anchored" data-anchor-id="spell-length-distributions">3. Spell Length Distributions</h3>
<p>Analysis of consecutive wet and dry periods:</p>
<ul>
<li>Mean wet spell length</li>
<li>Mean dry spell length</li>
<li>Distribution of spell durations</li>
</ul>
<p>This assesses the generator’s ability to capture persistence in weather patterns.</p>
</section>
<section id="spatial-correlations" class="level3">
<h3 class="anchored" data-anchor-id="spatial-correlations">4. Spatial Correlations</h3>
<p>Inter-site correlation matrices for each variable, comparing observed versus simulated spatial coherence. This is critical for applications requiring realistic spatial patterns (e.g., regional hydrology).</p>
</section>
</section>
<section id="viewing-evaluation-results" class="level2">
<h2 class="anchored" data-anchor-id="viewing-evaluation-results">Viewing Evaluation Results</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display all diagnostic plots</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>evaluation_plots</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$daily_mean</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$daily_sd</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$spell_length</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$wetdry_days_count</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$crossgrid</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$intergrid</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$precip_cond_cor</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$annual_pattern_precip</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$annual_pattern_temp</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$annual_pattern_temp_min</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$annual_pattern_temp_max</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-11.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$monthly_cycle</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-12.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$annual_precip</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="getting_started_files/figure-html/view_evaluation-13.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
attr(,"class")
[1] "weather_assessment" "list"              
attr(,"fit_summary")
# A tibble: 3 × 17
  rlz    rank overall_score mae_mean_precip mae_mean_temp mae_mean_temp_max
  &lt;chr&gt; &lt;int&gt;         &lt;dbl&gt;           &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 2         1         0.282            2.63          17.0              19.2
2 3         2         0.541            2.65          17.0              19.2
3 1         3         0.706            2.65          17.0              19.2
# ℹ 11 more variables: mae_mean_temp_min &lt;dbl&gt;, mae_sd_precip &lt;dbl&gt;,
#   mae_sd_temp &lt;dbl&gt;, mae_sd_temp_max &lt;dbl&gt;, mae_sd_temp_min &lt;dbl&gt;,
#   mae_days_Dry &lt;dbl&gt;, mae_days_Wet &lt;dbl&gt;, mae_spell_Dry &lt;dbl&gt;,
#   mae_spell_Wet &lt;dbl&gt;, mae_cor_crossgrid &lt;dbl&gt;, mae_cor_intervariable &lt;dbl&gt;
attr(,"metadata")
attr(,"metadata")$n_grids
[1] 6

attr(,"metadata")$n_realizations
[1] 3

attr(,"metadata")$variables
[1] "precip"   "temp"     "temp_min" "temp_max"

attr(,"metadata")$assessment_date
[1] "2026-01-16"</code></pre>
</div>
</div>
<section id="interpreting-the-plots" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-the-plots">Interpreting the Plots</h3>
<p>Good weather generator performance is indicated by:</p>
<ul>
<li><strong>Scatter plots near the 1:1 line</strong>: Simulated statistics closely match observed values</li>
<li><strong>Overlapping distributions</strong>: Similar shapes and ranges between observed and simulated</li>
<li><strong>Consistent correlation patterns</strong>: Spatial correlations preserved in synthetic data</li>
<li><strong>Balanced residuals</strong>: No systematic bias in any direction</li>
</ul>
<p>Discrepancies may indicate:</p>
<ul>
<li>Parameter tuning needed - adjust WARM or Markov chain thresholds</li>
<li>Insufficient historical analogue pool - increase KNN sample size</li>
<li>Structural limitations for specific climate regimes</li>
</ul>
</section>
</section>
</section>
<section id="other-features" class="level1">
<h1>Other Features</h1>
<p>The weathergenr package supports additional capabilities not covered in this basic tutorial:</p>
<section id="climate-scenario-analysis" class="level2">
<h2 class="anchored" data-anchor-id="climate-scenario-analysis">Climate Scenario Analysis</h2>
<p>Use <code>apply_climate_perturbations()</code> to modify synthetic weather based on climate change scenarios:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Apply temperature increase and precipitation changes</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>grid_with_lat <span class="ot">&lt;-</span> ncdata<span class="sc">$</span>grid</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>grid_with_lat<span class="sc">$</span>lat <span class="ot">&lt;-</span> grid_with_lat<span class="sc">$</span>y</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>perturbed_weather <span class="ot">&lt;-</span> <span class="fu">apply_climate_perturbations</span>(</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">lapply</span>(synthetic_data[[<span class="dv">1</span>]], <span class="cf">function</span>(df) {</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(df, <span class="at">prcp =</span> precip)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  }),</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> grid_with_lat,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> stochastic_weather<span class="sc">$</span>dates,</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">prcp_mean_factor =</span> <span class="fu">rep</span>(<span class="fl">1.1</span>, <span class="dv">12</span>),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">prcp_var_factor =</span> <span class="fu">rep</span>(<span class="fl">1.0</span>, <span class="dv">12</span>),</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_delta =</span> <span class="fu">rep</span>(<span class="fl">2.0</span>, <span class="dv">12</span>),</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_transient =</span> <span class="cn">FALSE</span>,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">prcp_transient =</span> <span class="cn">FALSE</span>,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">compute_pet =</span> <span class="cn">FALSE</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wavelet-spectral-analysis" class="level2">
<h2 class="anchored" data-anchor-id="wavelet-spectral-analysis">Wavelet Spectral Analysis</h2>
<p>Explore low-frequency climate variability using wavelet transforms:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze spectral characteristics of annual precipitation</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>wavelet_results <span class="ot">&lt;-</span> <span class="fu">analyze_wavelet_spectrum</span>(</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">series =</span> annual_precip,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">signif =</span> <span class="fl">0.90</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="st">"red"</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_period =</span> <span class="dv">2</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">detrend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"fast"</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parallel-computing" class="level2">
<h2 class="anchored" data-anchor-id="parallel-computing">Parallel Computing</h2>
<p>For large spatial domains, enable parallel processing to accelerate computation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate weather using multiple cores</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>stochastic_weather <span class="ot">&lt;-</span> <span class="fu">generate_weather</span>(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ... other parameters ...</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_cores =</span> <span class="dv">4</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="saving-and-exporting-results" class="level2">
<h2 class="anchored" data-anchor-id="saving-and-exporting-results">Saving and Exporting Results</h2>
<p>Results can be written back to NetCDF format for use in other tools:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Write synthetic weather to NetCDF</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>data_to_write <span class="ot">&lt;-</span> <span class="fu">lapply</span>(synthetic_data[[<span class="dv">1</span>]], <span class="cf">function</span>(df) {</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.list</span>(df[variables])</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_netcdf</span>(</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_to_write,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> ncdata<span class="sc">$</span>grid,</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_dir =</span> output_path,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">origin_date =</span> stochastic_weather<span class="sc">$</span>dates[<span class="dv">1</span>],</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">calendar =</span> <span class="st">"noleap"</span>,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">template_path =</span> ncfile,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_prefix =</span> <span class="st">"synthetic_weather"</span>,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">file_suffix =</span> <span class="st">"rlz1"</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="further-reading" class="level1">
<h1>Further Reading</h1>
<ul>
<li><strong>Methodological details</strong>: See Steinschneider and Brown (2013) for the theoretical foundation</li>
<li><strong>Package documentation</strong>: Use <code>?function_name</code> to access detailed help for any function</li>
</ul>
<hr>
<p><strong>Session Information</strong></p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.2 (2025-10-31 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default
  LAPACK version 3.12.1

locale:
[1] LC_COLLATE=English_United States.utf8 
[2] LC_CTYPE=English_United States.utf8   
[3] LC_MONETARY=English_United States.utf8
[4] LC_NUMERIC=C                          
[5] LC_TIME=English_United States.utf8    

time zone: Europe/Amsterdam
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] ggplot2_4.0.1     dplyr_1.1.4       weathergenr_0.9.0

loaded via a namespace (and not attached):
 [1] gtable_0.3.6       xfun_0.55          htmlwidgets_1.6.4  lattice_0.22-7    
 [5] quadprog_1.5-8     vctrs_0.6.5        tools_4.5.2        generics_0.1.4    
 [9] curl_7.0.0         parallel_4.5.2     tibble_3.3.1       proxy_0.4-29      
[13] xts_0.14.1         pkgconfig_2.0.3    Matrix_1.7-4       RColorBrewer_1.1-3
[17] S7_0.2.1           lifecycle_1.0.5    compiler_4.5.2     farver_2.1.2      
[21] textshaping_1.0.4  codetools_0.2-20   ncdf4_1.24         htmltools_0.5.9   
[25] class_7.3-23       yaml_2.3.12        pillar_1.11.1      tidyr_1.3.2       
[29] MASS_7.3-65        fitdistrplus_1.2-4 iterators_1.0.14   foreach_1.5.2     
[33] nlme_3.1-168       fracdiff_1.5-3     tidyselect_1.2.1   digest_0.6.39     
[37] purrr_1.2.1        labeling_0.4.3     tseries_0.10-59    splines_4.5.2     
[41] fastmap_1.2.0      grid_4.5.2         colorspace_2.1-2   cli_3.6.5         
[45] logger_0.4.1       magrittr_2.0.4     patchwork_1.3.2    utf8_1.2.6        
[49] survival_3.8-6     e1071_1.7-17       withr_3.0.2        scales_1.4.0      
[53] forecast_9.0.0     TTR_0.24.4         rmarkdown_2.30     quantmod_0.4.28   
[57] otel_0.2.0         nnet_7.3-20        timeDate_4051.111  gridExtra_2.3     
[61] ragg_1.5.0         zoo_1.8-15         urca_1.3-4         evaluate_1.0.5    
[65] knitr_1.51         lmtest_0.9-40      viridisLite_0.4.2  rlang_1.1.7       
[69] isoband_0.3.0      Rcpp_1.1.1         glue_1.8.0         rstudioapi_0.18.0 
[73] jsonlite_2.0.0     R6_2.6.1           systemfonts_1.3.1 </code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>