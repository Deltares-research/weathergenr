{
  "hash": "6bac578ec76881b278afd59db7b84952",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Climate Perturbations\"\ndescription: \"Applying monthly perturbations to stochastic weather, and validate precipitation changes.\"\nformat:\n  html:\n    toc: true\n    toc-location: left\n    toc-title: \"Contents\"\n    toc-depth: 2\n    toc-expand: 2\n    page-layout: full\n    number-sections: true\n    code-tools: true\n    df-print: tibble\n    self-contained: true\nexecute:\n  echo: true\n  warning: false\n  message: false\n  cache: false\n  freeze: true\n  execute-dir: project\nvignette: >\n  %\\VignetteIndexEntry{Climate Perturbations}\n  %\\VignetteEngine{quarto::html}\n  %\\VignetteEncoding{UTF-8}\n---\n\n# Purpose\n\nThis vignette demonstrates how to apply **climate perturbations** to daily\nweather series using `weathergenr`. The workflow modifies precipitation and\ntemperature in a controlled way to reflect user-defined stress scenarios while\npreserving realistic daily variability. This is useful for hydrological stress\ntesting, climate sensitivity analysis, and impact modeling.\n\n# Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(weathergenr)\nlibrary(ggplot2)\n\nncfile <- system.file(\"extdata\", \"ntoum_era5_data.nc\", package = \"weathergenr\")\nncdata <- read_netcdf(ncfile)\n```\n:::\n\n\n# Define climate scenario\n\nWe define a stress-test scenario representing a drier and warmer climate:\n30% reduction in mean precipitation and +2 degrees Celsius temperature increase.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nobs_date <- ncdata$date\nobs_month <- as.integer(format(obs_date, \"%m\"))\nobs_year <- as.integer(format(obs_date, \"%Y\"))\nobs_year_idx <- obs_year - min(obs_year) + 1L\nn_years <- max(obs_year_idx)\n\n# Monthly perturbation vectors (length 12)\nprecip_mean_change <- rep(0.7, 12)\nprecip_var_change <- rep(1.0, 12)\ntemp_mean_change <- rep(2, 12)\n\n# Expand to matrices (n_years x 12) for quantile mapping\nprecip_mean_change_m <- matrix(precip_mean_change, nrow = n_years, ncol = 12, byrow = TRUE)\nprecip_var_change_m <- matrix(precip_var_change, nrow = n_years, ncol = 12, byrow = TRUE)\n```\n:::\n\n\n# Preview quantile mapping\n\nBefore applying perturbations across all grid cells, we preview the\nquantile-mapping diagnostics on a single cell to verify target changes are\nachieved.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprecip_qm <- adjust_precipitation_qm(\n  precip = ncdata$data[[1]]$precip,\n  mean_factor = precip_mean_change_m,\n  var_factor = precip_var_change_m,\n  scale_var_with_mean = TRUE,\n  exaggerate_extremes = FALSE,\n  enforce_target_mean = TRUE,\n  month = obs_month,\n  year = obs_year_idx,\n  min_events = 10,\n  validate_output = TRUE,\n  diagnostics = TRUE,\n  verbose = FALSE\n)\n\nprint(precip_qm$diagnostics)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n=== Precipitation QM Diagnostics ===\n\nMean and variance changes:\n Statistic Original Adjusted Target Achieved Error\n      Mean     7.64     5.35   -30%     -30%   +0%\n  Variance    87.85    32.48   -51%     -63%  -12%\n\nWet/dry day counts:\n Category Original Adjusted Difference\n Dry days      161      183         22\n Wet days     7510     7488        -22\n\nPercentiles (wet days):\n   Percentile Original Adjusted Change\n P50 (Median)     5.62     4.03   -28%\n          P90    16.13    11.41   -29%\n          P95    20.52    14.55   -29%\n          P99    39.35    25.23   -36%\n\nExtreme tails:\n             Tail Threshold change Mean change\n    Top 10% (P90)             -29%        -34%\n     Top 5% (P95)             -29%        -36%\n     Top 1% (P99)             -36%        -43%\n Top 0.1% (P99.9)             -47%        -51%\n\nSpell lengths:\n       Type Original (days) Adjusted (days) Change\n Dry spells             1.3             1.3    +3%\n Wet spells            60.6            54.7   -10%\n\nMonthly mean changes:\n Month Target Achieved Error\n   Jan   -30%     -30%   +0%\n   Feb   -30%     -30%   +0%\n   Mar   -30%     -30%   +0%\n   Apr   -30%     -30%   +0%\n   May   -30%     -30%   +0%\n   Jun   -30%     -30%   +0%\n   Jul   -30%     -30%   -0%\n   Aug   -30%     -30%   +0%\n   Sep   -30%     -30%   +0%\n   Oct   -30%     -30%   +0%\n   Nov   -30%     -30%   +0%\n   Dec   -30%     -30%   +0%\n```\n\n\n:::\n:::\n\n\n# Apply climate perturbations\n\nThe `apply_climate_perturbations()` function processes all grid cells. It\naccepts a list of data frames (`data`), grid metadata (`grid`), and a date\nvector (`date`). Monthly perturbation factors control precipitation mean/variance\nscaling and temperature shifts. When `diagnostic = TRUE`, the function returns\nboth the perturbed data and validation diagnostics.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrlz_future <- apply_climate_perturbations(\n  data = ncdata$data,\n  grid = ncdata$grid,\n  date = ncdata$date,\n  precip_mean_factor = precip_mean_change,\n  precip_var_factor = precip_var_change,\n  temp_delta = temp_mean_change,\n  precip_occurrence_factor = NULL,\n  precip_intensity_threshold = 0,\n  temp_transient = TRUE,\n  precip_transient = TRUE,\n  precip_occurrence_transient = TRUE,\n  compute_pet = FALSE,\n  pet_method = \"hargreaves\",\n  qm_fit_method = \"mme\",\n  scale_var_with_mean = TRUE,\n  exaggerate_extremes = FALSE,\n  extreme_prob_threshold = 0.95,\n  extreme_k = 1.2,\n  enforce_target_mean = TRUE,\n  precip_cap_mm_day = NULL,\n  precip_floor_mm_day = NULL,\n  precip_cap_quantile = NULL,\n  seed = 42,\n  diagnostic = TRUE,\n  verbose = FALSE\n)\n```\n:::\n\n\nThe output contains `data` (list of perturbed data frames) and `diagnostic`\n(list of per-grid validation objects, precipitation only).\n\n# Visualizations\n\n## Monthly precipitation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nobs_cell <- ncdata$data[[1]]\nsim_cell <- rlz_future$data[[1]]\n\nobs_monthly <- tapply(obs_cell$precip, obs_month, mean, na.rm = TRUE)\nsim_monthly <- tapply(sim_cell$precip, obs_month, mean, na.rm = TRUE)\n\nplot_data <- data.frame(\n  Month = factor(month.abb[1:12], levels = month.abb),\n  Observed = as.numeric(obs_monthly),\n  Perturbed = as.numeric(sim_monthly)\n)\nplot_data_long <- tidyr::pivot_longer(\n  plot_data, cols = c(\"Observed\", \"Perturbed\"),\n  names_to = \"Series\", values_to = \"Precipitation\"\n)\n\nggplot(plot_data_long, aes(x = Month, y = Precipitation, fill = Series)) +\n  geom_col(position = \"dodge\", width = 0.7) +\n  scale_fill_manual(values = c(Observed = \"steelblue\", Perturbed = \"coral\")) +\n  labs(\n    title = \"Monthly Mean Precipitation\",\n    subtitle = \"Observed vs. perturbed (30% reduction scenario)\",\n    y = \"Precipitation (mm/day)\", x = NULL\n  ) +\n  theme_bw() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](climate_perturbation_files/figure-html/plot_monthly_precip-1.png){width=672}\n:::\n:::\n\n\n## Distribution comparison\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwet_obs <- obs_cell$precip[obs_cell$precip > 0]\nwet_sim <- sim_cell$precip[sim_cell$precip > 0]\n\ndist_data <- data.frame(\n\n  Precipitation = c(wet_obs, wet_sim),\n  Series = factor(\n    c(rep(\"Observed\", length(wet_obs)), rep(\"Perturbed\", length(wet_sim))),\n    levels = c(\"Observed\", \"Perturbed\")\n  )\n)\n\nggplot(dist_data, aes(x = Precipitation, color = Series, fill = Series)) +\n  geom_density(alpha = 0.3, linewidth = 1) +\n  scale_color_manual(values = c(Observed = \"steelblue\", Perturbed = \"coral\")) +\n  scale_fill_manual(values = c(Observed = \"steelblue\", Perturbed = \"coral\")) +\n  scale_x_continuous(limits = c(0, quantile(c(wet_obs, wet_sim), 0.98))) +\n  labs(\n    title = \"Wet-Day Precipitation Distribution\",\n    x = \"Precipitation (mm/day)\", y = \"Density\"\n  ) +\n  theme_bw() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](climate_perturbation_files/figure-html/plot_distribution-1.png){width=672}\n:::\n:::\n\n\n## Temperature time series\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_idx <- seq_len(nrow(obs_cell))\n\ntemp_ts <- data.frame(\n  Day = plot_idx,\n  Observed = obs_cell$temp[plot_idx],\n  Perturbed = sim_cell$temp[plot_idx]\n)\ntemp_ts_long <- tidyr::pivot_longer(\n  temp_ts, cols = c(\"Observed\", \"Perturbed\"),\n  names_to = \"Series\", values_to = \"Temperature\"\n)\n\nggplot(temp_ts_long, aes(x = Day, y = Temperature, color = Series)) +\n  geom_line(alpha = 0.7) +\n  scale_color_manual(values = c(Observed = \"steelblue\", Perturbed = \"coral\")) +\n  labs(\n    title = \"Daily Temperature Time Series\",\n    subtitle = \"Observed vs. +2 deg C shift scenario\",\n    x = \"Day\", y = \"Temperature (deg C)\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](climate_perturbation_files/figure-html/plot_temperature-1.png){width=672}\n:::\n:::\n\n\n# Use cases and extensions\n\n## Step changes\n\nFor immediate perturbations instead of transient ramps:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrlz_step <- apply_climate_perturbations(\n  data = ncdata$data, grid = ncdata$grid, date = ncdata$date,\n  precip_mean_factor = precip_mean_change,\n  precip_var_factor = precip_var_change,\n  temp_delta = temp_mean_change,\n  temp_transient = FALSE,\n  precip_transient = FALSE,\n  diagnostic = TRUE\n)\n```\n:::\n\n\n## Occurrence perturbations\n\nTo modify wet-day frequency:\n\n\n::: {.cell}\n\n```{.r .cell-code}\noccurrence_factor <- rep(1.0, 12)\noccurrence_factor[6:8] <- 0.8  # 20% fewer wet days in summer\n\nrlz_dry_summer <- apply_climate_perturbations(\n  data = ncdata$data, grid = ncdata$grid, date = ncdata$date,\n  precip_mean_factor = precip_mean_change,\n  precip_var_factor = precip_var_change,\n  precip_occurrence_factor = occurrence_factor,\n  temp_delta = temp_mean_change,\n  diagnostic = TRUE\n)\n```\n:::\n\n\n## PET recalculation\n\nTo propagate temperature changes to PET:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrlz_with_pet <- apply_climate_perturbations(\n  data = ncdata$data, grid = ncdata$grid, date = ncdata$date,\n  precip_mean_factor = precip_mean_change,\n  precip_var_factor = precip_var_change,\n  temp_delta = temp_mean_change,\n  compute_pet = TRUE,\n  pet_method = \"hargreaves\",\n  diagnostic = TRUE\n)\n```\n:::\n\n\n## Extreme amplification\n\nTo amplify upper-tail changes:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrlz_extreme <- apply_climate_perturbations(\n  data = ncdata$data, grid = ncdata$grid, date = ncdata$date,\n  precip_mean_factor = precip_mean_change,\n  precip_var_factor = precip_var_change,\n  temp_delta = temp_mean_change,\n  exaggerate_extremes = TRUE,\n  extreme_prob_threshold = 0.95,\n  extreme_k = 1.2,\n  diagnostic = TRUE\n)\n```\n:::\n\n\n# Session info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.5.2 (2025-10-31 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 26200)\n\nMatrix products: default\n  LAPACK version 3.12.1\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: Europe/Amsterdam\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] ggplot2_4.0.1     weathergenr_1.0.1\n\nloaded via a namespace (and not attached):\n [1] generics_0.1.4     tidyr_1.3.2        class_7.3-23       lattice_0.22-7    \n [5] digest_0.6.39      magrittr_2.0.4     evaluate_1.0.5     grid_4.5.2        \n [9] RColorBrewer_1.1-3 iterators_1.0.14   fastmap_1.2.0      Matrix_1.7-4      \n[13] foreach_1.5.2      jsonlite_2.0.0     e1071_1.7-17       nnet_7.3-20       \n[17] survival_3.8-6     forecast_9.0.0     purrr_1.2.1        scales_1.4.0      \n[21] codetools_0.2-20   cli_3.6.5          rlang_1.1.7        splines_4.5.2     \n[25] withr_3.0.2        yaml_2.3.12        otel_0.2.0         tools_4.5.2       \n[29] parallel_4.5.2     dplyr_1.1.4        ncdf4_1.24         colorspace_2.1-2  \n[33] fitdistrplus_1.2-4 curl_7.0.0         vctrs_0.6.5        R6_2.6.1          \n[37] zoo_1.8-15         proxy_0.4-29       lifecycle_1.0.5    tseries_0.10-59   \n[41] MASS_7.3-65        urca_1.3-4         pkgconfig_2.0.3    pillar_1.11.1     \n[45] gtable_0.3.6       quantmod_0.4.28    glue_1.8.0         Rcpp_1.1.1        \n[49] xfun_0.55          tibble_3.3.1       lmtest_0.9-40      tidyselect_1.2.1  \n[53] rstudioapi_0.18.0  knitr_1.51         farver_2.1.2       nlme_3.1-168      \n[57] htmltools_0.5.9    patchwork_1.3.2    labeling_0.4.3     xts_0.14.1        \n[61] rmarkdown_2.30     timeDate_4051.111  fracdiff_1.5-3     compiler_4.5.2    \n[65] quadprog_1.5-8     S7_0.2.1           TTR_0.24.4        \n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "climate_perturbation_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}