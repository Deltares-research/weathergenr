---
title: "Getting_started"
format: gfm
---

# Installation and setup

The latest version of the `weathergenr` package can be installed from GitHub and then loaded into your R environment:


```{r install, eval=FALSE, echo = FALSE}
devtools::install_github("Deltares/weathergenr", upgrade = "never")
```

Once installed, load the relevant packages:

```{r setup, eval=TRUE, echo = FALSE}
library(weathergenr)
library(dplyr)
library(ggplot2)
```

# :open_file_folder: Reading Gridded Multivariate Weather Data

For this exercise, we'll use the ERA5 dataset (ECMWF Reanalysis v5) included with the package, clipped over the Ntoum Basin in Gabon.

![Map of Ntoum Basin, Gabon](figures/ntoum_basin.png){width=60%}

Use readNetcdf() to extract meteorological data from NetCDF files. It wraps several ncdf4 functions and returns a structured object with:

- spatial coordinates
- dates
- grid info
- meteorological variables

```{r ncfile}
ncfile <- system.file("extdata", "ntoum_era5_data.nc", package = "weathergenr")
ncdata <- readNetcdf(ncfile)
```

Inspect the structure:
```{r ncdata1}
names(ncdata)
```

Each grid cell's data is stored as a tidy data frame within the data list:
```{r ncdata2}
ncdata$data[[1]]
```

Grid metadata can be accessed through the grid element:
```{r ncdata3}
ncdata$grid
```

Associated dates are accessed via the date element:
```{r ncdata4}
head(ncdata$date)
```

# :gear: Generate Stochastic Weather Realizations

We use generateWeatherSeries() to simulate new weather sequences from historical record using a coupled a Wavelet Autoregressive Model (WARM) with a a Markov Chain and KNN resampling scheme (See: [Steinscheineder et al (2013)](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/wrcr.20528)

Define output path, variables, and simulation parameters.
**realization_num** parameters sets how many stochastic replicates will be generated. 

```{r set_params}
output_path <- tempdir()
variables <- c("precip", "temp", "temp_min", "temp_max")
variable_labels <- c("Precip.", "Temp. (avg)", "Temp. (min)", "Temp. (max)")
realization_num <- 3
```

Call the generator:
```{r run_wegen, results='hide', eval=TRUE, cache=TRUE, warning = FALSE}
stochastic_weather <- generateWeatherSeries(
  weather.data = ncdata$data,
  weather.grid = ncdata$grid,
  weather.date = ncdata$date,
  variable.names = variables,
  variable.labels = variables,
  variable.units = NULL,
  sim.year.num = 20,
  sim.year.start = 2020,
  month.start = 1,
  realization.num = realization_num,
  warm.variable = "precip",
  warm.signif.level = 0.90,
  warm.sample.num = 10000,
  warm.subset.criteria = NULL,
  knn.sample.num = 100,
  mc.wet.quantile= 0.3,
  mc.extreme.quantile = 0.8,
  output.path = output_path,
  seed = 123)
```

Check resampled dates by the weather generator:

```{r stochastic3, cache=TRUE}
stochastic_weather$resampled
```

# :mag: Evaluate Synthetic Series

Compare stochastic simulations against historical data using **evaluateWegen** function:

```{r eval_outputs, message=FALSE, cache=TRUE, results = "hide", warning = FALSE}

day_order <- sapply(1:realization_num, 
                    function(n) match(stochastic_weather$resampled[[n]], ncdata$date))

rlz_sample <- list()
for (n in 1:realization_num) {
  rlz_sample[[n]] <- lapply(ncdata$data[ncdata$grid$id], function(x) x[day_order[,n],] %>%
                              select(precip,  temp, temp_min, temp_max) %>%
                              mutate(date = stochastic_weather$dates, .before = 1))
}

obs_sample <- lapply(ncdata$data[ncdata$grid$id], function(x) x %>%
                       select(precip, temp, temp_min, temp_max) %>%
                       dplyr::mutate(date = ncdata$date, .before = 1))

out <- evaluateWegen(daily.sim = rlz_sample,
              daily.obs = obs_sample,
              save.plots = FALSE,
              variables = variables,
              variable.labels = variable_labels,
              variable.units = NULL,
              realization.num = realization_num,
              wet.quantile = 0.3,
              extreme.quantile =0.8)
```

## Comparison plots

Daily statistics of all weather variables 
```{r eval_plots1, message=FALSE, cache=TRUE, results = "hide", warning = FALSE}
out$daily_means
out$daily_sd
out$annual_pattern_precip
out$annual_pattern_temp
out$annual_pattern_precip
out$annual_pattern_temp
out$annual_cycle
out$intergrid_cor
out$crossgrid_cor
out$spell_lengths
out$spell_duration
```
