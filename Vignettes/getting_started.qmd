---
title: "Getting_started"
format: html
vignette: >
  %\VignetteIndexEntry{Introduction to myPackage}
  %\VignetteEngine{quarto::quarto}
  %\VignetteEncoding{UTF-8}
execute:
  echo: true
  message: false
  warning: false
  cache: true
  fig-width: 6
  fig-height: 4
---

# Package summary

The package *weathergenr* consists of a series of R scripts and function wrappers for synthetic weather generation based on the work of [Steinscheineder et al (2013)](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/wrcr.20528).

This implementation provides:

-   Ability to work with gridded datasets via netcdf files
-   Script automatization and usability improvements\
-   Significant speed improvements through code vectorization and parallization

This vignette introduces you to the basic use of the multivariable, multigrid stochastic daily weather series generation process using *weathergenr*. You will learn\

-   Reading in gridded, multivariate weather data for a specific geographic area from netcdf files
-   Generating stochastic weather data based on the inputted gridded weather data
-   Perturbing statistics of selected variables such as daily precipitaton or temperature to develop climate change scenarios.

# Installation and setup

The latest version of the weathergenr package can be installed from github and then loaded to the environment:

```{r setup, eval=TRUE, echo = FALSE}
#devtools::install_github("Deltares/weathergenr", upgrade = "never")
library(weathergenr)

# Other R packages that needs to be installed:
library(dplyr)
library(ggplot2)
```

## Sample data

For this exercise, we will use the extracted ERA5 metereological dataset from the Ntoum basin, Gabon.

![Map of Ntoum Basin, Gabon](figures/ntoum_basin.png){#fig-basin}

# Reading in gridded multivariate weather data

First, we will upload the gridded multivariate data for the basin from a netcdf file. The *readNetcdf()* is a wrapper for several ncdf4 functions to extract metereological data from netcdf files with associated spatial coordinates, dates, dimensions (time, x, y) and variable attributes.

```{r ncfile}
ncfile <- system.file("extdata", "ntoum_era5_data.nc", package = "weathergenr")
ncdata <- readNetcdf(ncfile)
```

We can check the structure of this object:

```{r ncdata1}
names(ncdata)
```

Metereological data is stored as a list object via the *data* element. Each list represents a different grid cell in "tidy" format, i.e., with observations on rows and metereological variables on columns:

```{r ncdata2}
# Display climate data for the first gridcell
ncdata$data[[1]]
```

Information on the grids can be accessed via the *grid* element. It is also provided as a data frame with columns grid index followed by x and y dimension indices and x and y coordinate values:

```{r ncdata3}
# Display grid information
ncdata$grid
```

Finally, the date series associated with the data can be accessed with the *date* element:

```{r ncdata4}
# Display start and ending values date vector
head(ncdata$date)
```

# Generate stochastic weather realizations

In this section, we introduce the procedure to obtain new weather sequences from the historical weather record via the *generateWeatherSeries()* function. This function serves as a wrapper arround a number of statistical procedures including a wavelet autoregressive model (WARM) coupled with a Markov chain knn resampling scheme based on Steinschneider and Brown (2013).

First, lets specify an output path for the results and variables to include from the dataset:

```{r set_params}

# Set path to store weather generator results
output_path <- tempdir()

# Set the variables to include in the weather generator
variables <- c("precip", "temp", "temp_min", "temp_max")
variable_labels <- c("Precip.", "Temp. (avg)", "Temp. (min)", "Temp. (max)")
  
# Set the number of stochastic (random) realizations to be generated from the historical weather record
realization_num <- 3
```

GenerateWeatherSeries() function includes a large set of essential and non-essential parameters to control the weather generation process. Essential parameters include: *weather.data*, *weather.grid*, and *weather.date* and *variable.names* to specify the attributes of the input metereological data, *realization.num* to set the desired number of new weather realizations, and the *output.path*:

```{r run_wegen, results='hide', eval=TRUE, cache=TRUE}
stochastic_weather <- generateWeatherSeries(
  weather.data = ncdata$data,
  weather.grid = ncdata$grid,
  weather.date = ncdata$date,
  variable.names = variables,
  variable.labels = variables,
  variable.units = NULL,
  sim.year.num = 20,
  sim.year.start = 2020,
  month.start = 1,
  realization.num = realization_num,
  warm.variable = "precip",
  warm.signif.level = 0.90,
  warm.sample.num = 10000,
  warm.subset.criteria = NULL,
  knn.sample.num = 100,
  mc.wet.quantile= 0.3,
  mc.extreme.quantile = 0.8,
  output.path = output_path,
  seed = 123)

```

Output from weather generator is a list of resampled dates

```{r stochastic3}
# Resampled dates
stochastic_weather$resampled

# Date vector
head(stochastic_weather$dates)
tail(stochastic_weather$dates)
```

# Evaluate Synthetic series against observed data
Lets compare how the simulated stochastic series compare to the historical

```{r eval_outputs, message=FALSE}

# Find date order from each stochastic simulation
day_order <- sapply(1:realization_num, function(n) match(stochastic_weather$resampled[[n]], ncdata$date))

rlz_sample <- list()
for (n in 1:realization_num) {
  rlz_sample[[n]] <- lapply(ncdata$data[ncdata$grid$id], function(x) x[day_order[,n],] %>%
                              select(precip,  temp, temp_min, temp_max) %>%
                              mutate(date = stochastic_weather$dates, .before = 1))
}

obs_sample <- lapply(ncdata$data[ncdata$grid$id], function(x) x %>%
                       select(precip, temp, temp_min, temp_max) %>%
                       dplyr::mutate(date = ncdata$date, .before = 1))

out <- evaluateWegen(daily.sim = rlz_sample,
              daily.obs = obs_sample,
              save.plots = FALSE,
              variables = variables,
              variable.labels = variable_labels,
              variable.units = NULL,
              realization.num = realization_num,
              wet.quantile = 0.3,
              extreme.quantile =0.8)

# Daily means
out$daily_means

# Daily Standard deviations
out$daily_sd
```
